/*
 * Wazuh Vulnerability scanner - Scan Orchestrator
 * Copyright (C) 2015, Wazuh Inc.
 * Nov 23, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#ifndef _DETAILS_AUGMENTATION_HPP
#define _DETAILS_AUGMENTATION_HPP

#include "chainOfResponsability.hpp"
#include "databaseFeedManager.hpp"
#include "scanContext.hpp"

/**
 * @brief DetailsAugmentation class.
 *
 */
class DetailsAugmentation final : public AbstractHandler<std::shared_ptr<ScanContext>>
{
private:
    std::shared_ptr<DatabaseFeedManager> m_databaseFeedManager;

public:
    // LCOV_EXCL_START
    /**
     * @brief DetailsAugmentation constructor.
     *
     * @param databaseFeedManager Database feed manager.
     */
    explicit DetailsAugmentation(std::shared_ptr<DatabaseFeedManager>& databaseFeedManager)
        : m_databaseFeedManager(databaseFeedManager)
    {
    }
    /**
     * @brief Handles request and passes control to the next step of the chain.
     *
     * @param data Scan context.
     * @return std::shared_ptr<ScanContext> Abstract handler.
     */
    std::shared_ptr<ScanContext> handleRequest(std::shared_ptr<ScanContext> data) override
    {
        nlohmann::json package;
        package["architecture"] = data->packageArchitecture();
        package["build_version"] = ""; // TODO: Add build version.
        package["checksum"] = "";      // TODO: Add checksum.
        package["description"] = data->packageDescription();
        package["install_scope"] = ""; // TODO: Add install scope.
        if (!data->packageInstallTime().empty())
        {
            package["install_time"] = data->packageInstallTime();
        }
        package["license"] = ""; // TODO: Add license.
        package["name"] = data->packageName();
        package["path"] = data->packageLocation();
        package["reference"] = ""; // TODO: Add reference.
        package["size"] = data->packageSize();
        package["type"] = data->packageFormat();
        package["version"] = data->packageVersion();

        nlohmann::json ecs;
        ecs["version"] = "8.11.0";

        nlohmann::json agent;
        agent["build"]["original"] = "40800"; // TODO: Remove hardcoded revision.
        agent["ephemeral_id"] = data->agentNodeName();
        agent["id"] = data->agentId();
        agent["name"] = data->agentName();
        agent["ip"] = data->agentIp();
        agent["type"] = "wazuh";
        agent["version"] = "4.8.0"; // TODO: Remove hardcoded version.

        for (auto& [cve, json] : data->m_elements)
        {
            FlatbufferDataPair<VulnerabilityDescription> returnData;
            m_databaseFeedManager->getVulnerabiltyDescriptiveInformation(cve, returnData);
            if (returnData.data)
            {
                auto ecsData = nlohmann::json::object();
                // ECS agent fields.
                ecsData["agent"] = agent;
                // ECS fields.
                ecsData["ecs"] = ecs;
                // ECS package fields.
                ecsData["package"] = package;
                // ECS vulnerability fields.
                ecsData["vulnerability"]["category"] = "Packages";
                ecsData["vulnerability"]["classification"] = returnData.data->classification()->str();
                ecsData["vulnerability"]["description"] = returnData.data->description()->str();
                ecsData["vulnerability"]["enumeration"] = "CVE";
                ecsData["vulnerability"]["id"] = cve;
                ecsData["vulnerability"]["reference"] = returnData.data->reference()->str();
                ecsData["vulnerability"]["report_id"] = ""; // TODO: Add report id.
                ecsData["vulnerability"]["scanner"]["vendor"] = "Wazuh";
                ecsData["vulnerability"]["score"]["base"] = returnData.data->scoreBase();
                ecsData["vulnerability"]["score"]["environmental"] = 0.0f; // TODO: Add environmental score.
                ecsData["vulnerability"]["score"]["temporal"] = 0.0f;      // TODO: Add temporal score.
                ecsData["vulnerability"]["score"]["version"] = returnData.data->scoreVersion()->str();
                ecsData["vulnerability"]["severity"] = returnData.data->severity()->str();

                json["operation"] = "INSERTED";
                json["id"] = std::string(data->agentNodeName()) + "_" + std::string(data->agentId()) + "_" +
                             std::string(data->packageItemId()) + "_" + cve;
                json["data"] = ecsData;
            }
        }

        return AbstractHandler<std::shared_ptr<ScanContext>>::handleRequest(data);
    }
    // LCOV_EXCL_STOP
};

#endif // _DETAILS_AUGMENTATION_HPP
